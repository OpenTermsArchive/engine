name: Test

on:
  push:
    branches-ignore:
      - main # tests will be launched by workflow_call from the deploy workflow
  pull_request:
    types: [ opened, reopened ]
  workflow_call:

jobs:
  check_changelog:
    runs-on: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v2
      - name: Get release type in changelog
        run: echo "RELEASE_TYPE=$(cat CHANGELOG.md | grep -E '^## Unreleased \[(patch|minor|major)\]$' | grep -E -w -o "patch|minor|major")" >> $GITHUB_ENV
      - name: Make release type available to subsequent jobs
        if: env.RELEASE_TYPE
        run: echo "RELEASE_TYPE is defined and equal ${{ env.RELEASE_TYPE }}"
      - name: Fail and display error is proper release type is not found in changelog
        if: env.RELEASE_TYPE == ''
        run: echo "No valid release type found in changelog. The title of the 'Unreleased' section must contain one of the following tag [patch], [minor], [major]. Ex Unreleased [minor]."; exit 1
